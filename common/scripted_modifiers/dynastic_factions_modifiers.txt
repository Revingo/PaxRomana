dynastic_faction_modifiers = {
	modifier = {
		desc = "FACTION_REASON_ELECTOR"

		add = {
			value = -150
			if = {
				limit = {
					exists = title:e_alexander_makedon
					$FACTION_TARGET$ = {
						has_primary_title = title:e_alexander_makedon
					}
				}
				add = -150
			}
		}
		$FACTION_TARGET$.primary_title = {
			has_order_of_succession = election
			any_elector = {
				this = root	
			}
		}
		faith = {
			faith_hostility_level = {
				target = $FACTION_TARGET$.faith
				value <= faith_astray_level
			}
		}
	}

	# Kingdoms gain an additional boost to independence, as they don't like being under the thumb of others.
	modifier = {
		desc = "FACTION_REASON_KING"
		add = { # High-grandeur Kings will want independence even more
			value =	50
			if = {
				limit = {
					has_royal_court = yes
					$FACTION_TARGET$ = {
						has_royal_court = yes
					}
					court_grandeur_current_level > $FACTION_TARGET$.court_grandeur_current_level
				}
				add = {
					add = court_grandeur_current_level
					subtract = $FACTION_TARGET$.court_grandeur_current_level
					multiply = 15
				}
			}
		}
		highest_held_title_tier = tier_kingdom
	}

	# Lowers independence wishes from Counts.
	modifier = {
		desc = "FACTION_REASON_COUNT"
		add = -25
		highest_held_title_tier = tier_county
	}

	# Toe the Line Perk
	modifier = {
		desc = "FACTION_REASON_PERK_TOE_THE_LINE"
		add = -50
		$FACTION_TARGET$ = {
			has_perk = toe_the_line_perk
		}
	}

	# Stem Duchies innovation
	modifier = {
		desc = "FACTION_REASON_INNOVATION_STEM_DUCHIES"
		add = -25
		$FACTION_TARGET$ = { culture = { has_innovation = innovation_stem_duchies }	}
		culture = { has_same_culture_heritage = $FACTION_TARGET$.culture }
	}

	# Characters are less likely to join if cultural acceptance is high
	modifier = {
		desc = "FACTION_REASON_CULTURE_ACCEPTANCE"
		culture = {
			NOR = {
				this = $FACTION_TARGET$.culture
				cultural_acceptance = { target = $FACTION_TARGET$.culture value >= 90 } # Essentially the same culture
				has_cultural_parameter = doesnt_care_about_culture_faith_in_factions
			}
		}
		add = {
			value = 20
			if = {
				limit = {
					culture = {
						cultural_acceptance = { target = $FACTION_TARGET$.culture value <= 20 }
					}
				}
				add = 20
			}
			if = {
				limit = {
					culture = {
						cultural_acceptance = { target = $FACTION_TARGET$.culture value <= 35 }
					}
				}
				add = 15
			}
			if = {
				limit = {
					culture = {
						cultural_acceptance = { target = $FACTION_TARGET$.culture value <= 50 }
					}
				}
				add = 10
			}
			if = {
				limit = {
					culture = {
						cultural_acceptance = { target = $FACTION_TARGET$.culture value <= 70 }
					}
				}
				add = 5
			}
			if = {
				limit = {
					culture = {
						cultural_acceptance = { target = $FACTION_TARGET$.culture value <= 80 }
					}
				}
				add = 5
			}
			if = { # The liege knowing your language cuts this penalty in half
				limit = {
					$FACTION_TARGET$ = {
						knows_language_of_culture = prev.culture
					}
				}
				multiply = 0.5
			}
		}
	}

	# TO DO: DIADOCHI STRUGGLE PREFERS TO REBEL LEADER
	modifier = {
		desc = "FACTION_REASON_PREFER_DISSOLUTION_FACTION"
		add = {
			value = 0
			# Some phases give a low chance...
			if = {
				limit = {
					$FACTION_TARGET$ = {
						any_character_struggle = {
							is_struggle_type = iberian_struggle
							involvement = involved
							OR = {
								is_struggle_phase = struggle_iberia_phase_hostility
								is_struggle_phase = struggle_iberia_phase_opportunity
							}
						}
					}
				}
				add = -100
			}
		}
		$FACTION_TARGET$ = {
			any_character_struggle = {
				is_struggle_type = iberian_struggle
				involvement = involved
			}
		}
		OR = {
			is_powerful_vassal_of = $FACTION_TARGET$
			$FACTION_TARGET$ = {
				any_targeting_faction = {
					faction_is_type = nation_fracturing_faction
				}
			}
		}
	}
	
	modifier = { # New vassals do not want to join independence factions
		desc = "FACTION_REASON_NEW_VASSAL"
		add = -1000
		has_opinion_modifier = {
			modifier = became_vassal
			target = $FACTION_TARGET$
		}
	}
}

army_discontent_progress_modifier = {
	modifier = {
		$FACTION_TARGET$.var:army_h_amount <= 10

		add = 5
	}
	modifier = {
		$FACTION_TARGET$.var:army_h_amount > 10

		add = {
			add = 5
			multiply = -4
		}
	}
}

nobles_discontent_progress_modifier = {
	modifier = {
		$FACTION_TARGET$.var:nobles_h_amount <= 10

		add = 5
	}
	modifier = {
		$FACTION_TARGET$.var:nobles_h_amount > 10

		add = {
			add = 5
			multiply = -4
		}
	}
}

citizens_discontent_progress_modifier = {
	modifier = {
		$FACTION_TARGET$.var:citizens_h_amount <= 10

		add = 5
	}
	modifier = {
		$FACTION_TARGET$.var:citizens_h_amount > 10

		add = {
			add = 5
			multiply = -4
		}
	}
}

on_army_uprising_war_win_common = {

	# If the claimant is the prisoner of the defender, free the claimant (it doesn't make much sense to leave the new king in the old king's dungeon)
	$CLAIMANT$ = {
		if = {
			limit = {
				is_imprisoned_by = $DEFENDER$
			}
			release_from_prison = yes
		}
	}

	# Add mutual opinion bonuses between claimant and faction members, as well as a hook on the claimant if possible.
	$ATTACKER$.joined_faction = {
		every_faction_member = {
			custom = FACTION_CLAIMANT_EVERY_FACTION_MEMBER
			limit = {
				NOT = { this = $ATTACKER$.joined_faction.special_character }
			}
			hidden_effect = {
				add_opinion = {
					modifier = claimant_faction_member_opinion
					target = $ATTACKER$.joined_faction.special_character
				}
				reverse_add_opinion = {
					modifier = claimant_faction_claimant_opinion
					target = $ATTACKER$.joined_faction.special_character
				}
			}
			if = {
				limit = {
					can_add_hook = {
						type = favor_hook
						target = $ATTACKER$.joined_faction.special_character
					}
				}
				add_hook = {
					type = favor_hook
					target = $ATTACKER$.joined_faction.special_character
				}
			}
			# Struggle boost
			if = {
				limit = {
					culture = $ATTACKER$.joined_faction.special_character.culture
					any_character_struggle = {
						involvement = involved
						has_struggle_phase_parameter = struggle_prestige_install_same_culture_claimant
					}
				}
				add_prestige = major_prestige_gain
			}
		}
	}

	# Give the claimant their new title.
	create_title_and_vassal_change = {
		type = faction_demand
		save_scope_as = change
		add_claim_on_loss = yes
	}

	every_in_list = {
		list = $TARGET_TITLES$
		add_to_list = faction_titles
		holder = {
			save_scope_as = target_holder
		}
	}
	ordered_in_list = {
		list = $TARGET_TITLES$
		position = 0
		order_by = tier
		save_scope_as = target_title
	}
	$ATTACKER$.joined_faction = {
		every_faction_county_member = {
			limit = {
				NOT = { is_in_list = faction_titles }
			}
			add_to_list = faction_titles
		}
	}

	setup_claim_cb = {
		titles = faction_titles
		attacker = $ATTACKER$
		defender = $DEFENDER$
		claimant = $CLAIMANT$
		change = scope:change
		civil_war = yes
	}

	# Ensure that the liege structure is preserved
	if = {
		limit = {
			scope:target_title.holder = { is_independent_ruler = no }
			$CLAIMANT$.primary_title.tier < scope:target_title.tier
		}
		$CLAIMANT$ = {
			change_liege = {
				liege = scope:target_title.holder.liege
				change = scope:change
			}
		}
	}

	# Preserve Grandeur
	if = {
		limit = {
			scope:target_title.holder = {
				has_royal_court = yes
			}
			$CLAIMANT$ = {
				has_royal_court = no
			}
		}
		$CLAIMANT$ = {
			set_variable = {
				name = previous_holder_grandeur_value
				value = scope:target_title.holder.court_grandeur_current
			}
			save_scope_as = claimant_scope # The CLAIMANT scope is lost after the next step, so have to save the scope here
		}
	}

	resolve_title_and_vassal_change = scope:change
	
	# We give you decent Legitimacy so you don't get immediately deposed - people _really_ want you in the throne
	# Can you even get Legitimacy?
	if = {
		limit = {
			$CLAIMANT$ = {
				is_valid_for_legitimacy_change = yes
			}
		}
		# Per tier
		if = {
			limit = {
				scope:target_title.tier = tier_empire
			}
			$CLAIMANT$ = {
				add_legitimacy = 1000
			}
		}
		else_if = {
			limit = {
				scope:target_title.tier = tier_kingdom
			}
			$CLAIMANT$ = {
				add_legitimacy = 750
			}
		}
		else_if = {
			limit = {
				scope:target_title.tier = tier_duchy
			}
			$CLAIMANT$ = {
				add_legitimacy = 500
			}
		}
		else = {
			$CLAIMANT$ = {
				add_legitimacy = 300
			}
		}
		# Per number of faction members
		$ATTACKER$.joined_faction = {
			every_faction_member = {
				add_to_list = num_faction_members
			}
		}
		if = {
			limit = {
				list_size:num_faction_members > 0
				$CLAIMANT$ = {
					is_valid_for_legitimacy_change = yes
				}
			}
			$CLAIMANT$ = {
				add_legitimacy = {
					value = list_size:num_faction_members
					multiply = 50
				}
			}
		}
	}

	# Add Appropriate Grandeur
	if = {
		limit = { exists = scope:claimant_scope }
		scope:claimant_scope = {
			if = {
				limit = {
					exists = var:previous_holder_grandeur_value
					has_royal_court = yes
				}
				hidden_effect = {
					change_current_court_grandeur = -100 # Reset to 0
					change_current_court_grandeur = var:previous_holder_grandeur_value
					remove_variable = previous_holder_grandeur_value
				}
				change_current_court_grandeur = massive_court_grandeur_gain # Gain a bonus to Grandeur for winning a claim faction
			}
		}
	}

	# TODO Add prestige effects based on $ATTACKER_PRESTIGE$ and $DEFENDER_PRESTIGE$
}